import NextAuth from "next-auth"
import CredentialsProvider from "next-auth/providers/credentials"

export default NextAuth({
  providers: [
    CredentialsProvider({
      name: "Credentials",
      credentials: {
        email: { label: "Email", type: "text" },
        password: { label: "Password", type: "password" }
      },
      async authorize(credentials) {
        const res = await fetch("/api/login", {
          method: 'POST',
          body: JSON.stringify(credentials),
          headers: { "Content-Type": "application/json" }
        });
        const user = await res.json();
        if (res.ok && user.access_token) {
          return { ...user, email: credentials.email }
        }
        return null;
      }
    })
  ],
  session: {
    strategy: "jwt"
  }
});





------------------------
import React, { useState } from 'react';

async function signIn(username, password) {
  const res = await fetch('http://localhost:8000/login', {
    method: 'POST',
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({ username, password })
  });
  const data = await res.json();
  if (data.access_token) {
    localStorage.setItem('accessToken', data.access_token); // Save for future API use
  }
  return data;
}

export default function LoginPage() {
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');

  async function handleSubmit(e) {
    e.preventDefault();
    const result = await signIn(username, password);
    if (!result.access_token) {
      setError('Invalid username or password');
    } else {
      setError('');
      // Optionally redirect or update UI
      // window.location.href = '/dashboard'  // Example redirect
    }
  }

  return (
    <form onSubmit={handleSubmit}>
      <div>
        <label>Username:</label>
        <input
          value={username}
          onChange={e => setUsername(e.target.value)}
          type="text"
          required
        />
      </div>
      <div>
        <label>Password:</label>
        <input
          value={password}
          onChange={e => setPassword(e.target.value)}
          type="password"
          required
        />
      </div>
      <button type="submit">Sign In</button>
      {error && <div style={{color: 'red'}}>{error}</div>}
    </form>
  );
}




=----------------
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";

export default function LoginPage() {
  const [username, setUsername] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");
  const router = useRouter();

  async function signIn(username, password) {
    try {
      const res = await fetch("http://localhost:8000/login", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({ username, password }),
      });

      const data = await res.json();

      if (data.access_token) {
        // Save token in localStorage
        localStorage.setItem("accessToken", data.access_token);
        // Redirect to dashboard or home
        router.push("/dashboard");
      } else {
        setError(data.detail || "Login failed. Please check your credentials.");
      }
    } catch (err) {
      console.error("Login error:", err);
      setError("Something went wrong. Please try again later.");
    }
  }

  const handleSubmit = (e) => {
    e.preventDefault();
    signIn(username, password);
  };

  return (
    <div className="flex items-center justify-center min-h-screen bg-gray-100">
      <form
        onSubmit={handleSubmit}
        className="bg-white shadow-lg rounded-2xl p-8 w-96"
      >
        <h1 className="text-2xl font-bold mb-6 text-center">Login</h1>

        <input
          type="text"
          placeholder="Username"
          value={username}
          onChange={(e) => setUsername(e.target.value)}
          className="w-full p-2 mb-4 border border-gray-300 rounded-lg"
          required
        />

        <input
          type="password"
          placeholder="Password"
          value={password}
          onChange={(e) => setPassword(e.target.value)}
          className="w-full p-2 mb-4 border border-gray-300 rounded-lg"
          required
        />

        {error && <p className="text-red-600 text-sm mb-4">{error}</p>}

        <button
          type="submit"
          className="w-full bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition"
        >
          Sign In
        </button>
      </form>
    </div>
  );
}




------------------------
minimum code
✅ Backend (FastAPI)

In your existing /login endpoint — just replace the return line with this:

from fastapi.responses import JSONResponse

response = JSONResponse({"message": "Login successful"})
response.set_cookie(
    key="token",
    value=access_token,
    httponly=True,
    samesite="lax",
    secure=False  # set True in production with HTTPS
)
return response


That’s it — no other backend changes needed.

✅ Frontend (Next.js)

In your login fetch call, add only one line:

const res = await fetch("http://localhost:8000/auth/login", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ email, password }),
  credentials: "include",  // <-- add this
});


✅ Now the backend sets the token as a cookie,
✅ The middleware detects it automatically,
✅ You don’t touch existing routes or components.

----------------------------

admin
@app.get("/admin/stats")
async def get_stats():
    return {
        "total_users": count_users(),
        "active_tokens": count_active_tokens(),
    }
@app.post("/refresh")
async def refresh_token(refresh_token: str):
    user = verify_refresh_token(refresh_token)
    new_access_token = create_access_token({"sub": user["username"]})
    return {"access_token": new_access_token}
@app.get("/profile", response_model=UserProfile)
async def get_profile(token: str = Depends(oauth2_scheme)):
    payload = decode_access_token(token)
    user = get_user(payload["sub"])  # your DB call
    if not user:
        raise HTTPException(status_code=404, detail="User not found")
    return user



    ----------------------exp 
    // pages/login.tsx
async function handleLogin(e: React.FormEvent) {
  e.preventDefault();
  const res = await fetch("http://localhost:8000/login", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({ username, password }),
  });
  const data = await res.json();

  if (data.access_token) {
    localStorage.setItem("token", data.access_token);
    window.location.href = "/home"; // redirect after login
  } else {
    alert("Invalid credentials");
  }
}



----------------------------------------

